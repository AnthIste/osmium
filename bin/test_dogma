#!/usr/bin/env php
<?php
/* Osmium
 * Copyright (C) 2012 Romain "Artefact2" Dalmaso <artefact2@gmail.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

require __DIR__.'/../inc/root.php';

/* Just to test the dogma expression eval code, we try to eval all
 * preexpressions then all postexpressions. Proccess could be
 * memory-intensive. */

\Osmium\Fit\create($fit);

$q = \Osmium\Db\query('SELECT typeid FROM osmium.invships ORDER BY typeid ASC;');
while($r = \Osmium\Db\fetch_row($q)) {
	\Osmium\Fit\select_ship($fit, $r[0]);
	echo $r[0]."\n";
}

\Osmium\Fit\select_ship($fit, 644);

$q = \Osmium\Db\query('SELECT typeid FROM osmium.invmodules ORDER BY typeid ASC;');
while($r = \Osmium\Db\fetch_row($q)) {
	\Osmium\Fit\add_module($fit, 0, $r[0]);
	\Osmium\Fit\remove_module($fit, 0, $r[0]);
	echo $r[0]."\n";
}

$typeid = null;
$q = \Osmium\Db\query('SELECT moduleid, chargeid FROM osmium.invcharges ORDER BY moduleid ASC, chargeid ASC;');
while($r = \Osmium\Db\fetch_row($q)) {
	if($typeid !== $r[0]) {
		\Osmium\Fit\add_module($fit, 0, $r[0]);
		$typeid = $r[0];

		unset($type);
		foreach($fit['modules'] as $f_type => $a) {
			if(count($a) == 1) {
				$type = $f_type;
				break;
			}
		}
	}

	echo $r[0]."->".$r[1]."\n";
	\Osmium\Fit\add_charge($fit, 'Default', $type, 0, $r[1]);
}